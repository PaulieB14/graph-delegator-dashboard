<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Graph Delegator Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #6F4CFF 0%, #0C0A1D 100%);
            min-height: 100vh;
            padding: 20px;
            color: #0C0A1D;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #F8F6FF;
            border-radius: 24px;
            box-shadow: 0 32px 64px rgba(12, 10, 29, 0.25);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6F4CFF 0%, #4C66FF 100%);
            color: #F8F6FF;
            padding: 60px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(248,246,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(248,246,255,0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .brand-logo {
            display: inline-flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .graph-logomark {
            width: 64px;
            height: 64px;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2));
        }

        .graph-logomark path {
            fill: #F8F6FF;
        }

        .graph-wordmark {
            height: 48px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .graph-wordmark path {
            fill: #F8F6FF;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 16px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .header p {
            font-size: 1.25rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
            font-weight: 400;
        }

        .search-section {
            padding: 60px 40px;
            background: #F8F6FF;
            border-bottom: 1px solid rgba(73, 71, 85, 0.2);
        }

        .search-box {
            display: flex;
            gap: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            padding: 20px 28px;
            border: 2px solid rgba(73, 71, 85, 0.3);
            border-radius: 16px;
            font-size: 16px;
            background: white;
            color: #0C0A1D;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .search-input:focus {
            outline: none;
            border-color: #6F4CFF;
            box-shadow: 0 0 0 4px rgba(111, 76, 255, 0.12), 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .search-btn {
            padding: 20px 36px;
            background: linear-gradient(135deg, #6F4CFF 0%, #4C66FF 100%);
            color: #F8F6FF;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            box-shadow: 0 8px 24px rgba(111, 76, 255, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(111, 76, 255, 0.4);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            padding: 60px 40px;
            background: #F8F6FF;
        }

        .portfolio-summary {
            background: linear-gradient(135deg, #6F4CFF 0%, #4C66FF 100%);
            border-radius: 24px;
            padding: 48px;
            margin-bottom: 48px;
            color: #F8F6FF;
            box-shadow: 0 20px 40px rgba(111, 76, 255, 0.25);
            position: relative;
            overflow: hidden;
        }

        .portfolio-summary::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(248,246,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        .portfolio-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .portfolio-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 32px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            text-align: center;
            background: rgba(248, 246, 255, 0.15);
            padding: 24px;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(248, 246, 255, 0.2);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .delegation-card {
            background: white;
            border: 1px solid rgba(73, 71, 85, 0.15);
            border-radius: 24px;
            padding: 36px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(12, 10, 29, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .delegation-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 48px rgba(12, 10, 29, 0.15);
            border-color: rgba(111, 76, 255, 0.3);
        }

        .indexer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 24px;
        }

        .indexer-info {
            display: flex;
            align-items: flex-start;
            gap: 24px;
            flex: 1;
        }

        .indexer-avatar {
            width: 88px;
            height: 88px;
            border-radius: 20px;
            background: linear-gradient(135deg, #6F4CFF 0%, #4C66FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #F8F6FF;
            font-weight: 800;
            font-size: 2.2rem;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 12px 24px rgba(111, 76, 255, 0.3);
            border: 2px solid rgba(248, 246, 255, 0.2);
        }

        .indexer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 18px;
        }

        .indexer-details-header {
            flex: 1;
            min-width: 0;
        }

        .indexer-name {
            font-size: 1.75rem;
            font-weight: 700;
            color: #0C0A1D;
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }

        .indexer-description {
            font-size: 1rem;
            color: #494755;
            line-height: 1.6;
            margin-bottom: 16px;
            max-height: 96px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .indexer-links {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .indexer-url {
            color: #6F4CFF;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(111, 76, 255, 0.08);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(111, 76, 255, 0.2);
        }

        .indexer-url:hover {
            background: #6F4CFF;
            color: #F8F6FF;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(111, 76, 255, 0.3);
        }

        .status-badge {
            padding: 14px 24px;
            border-radius: 32px;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            white-space: nowrap;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            letter-spacing: 0.02em;
        }

        .status-active {
            background: linear-gradient(135deg, #4BCA81 0%, #66D8FF 100%);
            color: white;
        }

        .status-inactive {
            background: linear-gradient(135deg, #FF79C6 0%, #FF6B9D 100%);
            color: white;
        }

        .delegation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .delegation-stat {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #F8F6FF 0%, rgba(111, 76, 255, 0.04) 100%);
            border: 1px solid rgba(73, 71, 85, 0.15);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .delegation-stat:hover {
            border-color: rgba(111, 76, 255, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(111, 76, 255, 0.1);
        }

        .delegation-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0C0A1D;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .delegation-stat-label {
            font-size: 0.95rem;
            color: #494755;
            font-weight: 600;
        }

        .gain-positive {
            color: #4BCA81;
        }

        .gain-negative {
            color: #FF79C6;
        }

        .indexer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            padding: 32px;
            background: linear-gradient(135deg, #F8F6FF 0%, rgba(111, 76, 255, 0.02) 100%);
            border: 1px solid rgba(73, 71, 85, 0.15);
            border-radius: 20px;
            font-size: 1rem;
            margin-bottom: 24px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(73, 71, 85, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #494755;
            font-weight: 600;
        }

        .detail-value {
            color: #0C0A1D;
            font-weight: 700;
            text-align: right;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            padding: 32px;
            background: linear-gradient(135deg, #4BCA81 0%, #66D8FF 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 16px 32px rgba(75, 202, 129, 0.25);
        }

        .metric-item {
            text-align: center;
            background: rgba(248, 246, 255, 0.15);
            padding: 24px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(248, 246, 255, 0.2);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .metric-label {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .powered-by {
            background: linear-gradient(135deg, #4BCA81 0%, #66D8FF 100%);
            border-radius: 24px;
            padding: 40px;
            margin: 40px 0;
            color: white;
            text-align: center;
            box-shadow: 0 20px 40px rgba(75, 202, 129, 0.25);
        }

        .powered-by h3 {
            margin-bottom: 16px;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .loading {
            text-align: center;
            padding: 80px;
            color: #494755;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .error {
            background: linear-gradient(135deg, #FF79C6 0%, #FF6B9D 100%);
            color: white;
            border-radius: 20px;
            padding: 32px;
            margin: 32px 0;
            box-shadow: 0 16px 32px rgba(255, 121, 198, 0.25);
        }

        .error h3 {
            margin-bottom: 12px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .error-details {
            margin-top: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .demo-addresses {
            margin-top: 32px;
            padding: 32px;
            background: white;
            border-radius: 20px;
            border: 1px solid rgba(73, 71, 85, 0.15);
            box-shadow: 0 8px 24px rgba(73, 71, 85, 0.08);
        }

        .demo-title {
            font-weight: 700;
            color: #0C0A1D;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .demo-address {
            display: inline-block;
            background: linear-gradient(135deg, #F8F6FF 0%, rgba(111, 76, 255, 0.04) 100%);
            padding: 14px 20px;
            margin: 8px;
            border-radius: 16px;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(73, 71, 85, 0.15);
            font-weight: 600;
        }

        .demo-address:hover {
            background: #6F4CFF;
            color: #F8F6FF;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(111, 76, 255, 0.3);
        }

        .created-date {
            font-size: 0.95rem;
            color: #494755;
            margin-top: 8px;
            font-weight: 500;
        }

        .retry-btn {
            margin-top: 16px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .brand-logo {
                flex-direction: column;
                gap: 16px;
            }
            
            .graph-wordmark {
                height: 36px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .portfolio-stats {
                grid-template-columns: 1fr;
            }
            
            .delegation-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .indexer-details {
                grid-template-columns: 1fr;
            }

            .indexer-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .indexer-avatar {
                width: 72px;
                height: 72px;
                font-size: 1.8rem;
            }

            .container {
                margin: 10px;
                border-radius: 20px;
            }

            .performance-metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="brand-logo">
                    <svg class="graph-logomark" width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M29 43.9999C19.08 43.9999 11 35.9299 11 25.9999C11 16.0699 19.08 7.9999 29 7.9999C38.92 7.9999 47 16.0699 47 25.9999C47 35.9299 38.92 43.9999 29 43.9999ZM29 13.9999C22.38 13.9999 17 19.3799 17 25.9999C17 32.6199 22.38 37.9999 29 37.9999C35.62 37.9999 41 32.6199 41 25.9999C41 19.3799 35.62 13.9999 29 13.9999ZM34.12 61.1199L46.12 49.1199C47.29 47.9499 47.29 46.0499 46.12 44.8799C44.95 43.7099 43.05 43.7099 41.88 44.8799L29.88 56.8799C28.71 58.0499 28.71 59.9499 29.88 61.1199C30.47 61.7099 31.23 61.9999 32 61.9999C32.77 61.9999 33.54 61.7099 34.12 61.1199ZM50 7.3999C48.02 7.3999 46.4 9.0199 46.4 10.9999C46.4 12.9799 48.02 14.5999 50 14.5999C51.98 14.5999 53.6 12.9799 53.6 10.9999C53.6 9.0199 51.98 7.3999 50 7.3999Z" fill="#F8F6FF"/>
                    </svg>
                    <svg class="graph-wordmark" width="208" height="48" viewBox="0 0 208 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.9729 35.2826V11.4244H21.9395V5.66841H0V11.4244H7.88321V35.2826H13.9729ZM30.9072 35.2826V25.1053C30.9072 21.1011 32.9093 19.1825 35.537 19.1825C37.9145 19.1825 39.2075 21.0177 39.2075 24.0209V35.2826H44.9218V23.0615C44.9218 17.6392 41.9187 13.9687 36.8718 13.9687C34.1606 13.9687 31.9917 15.1366 30.9072 16.805V4H25.1929V35.2826H30.9072ZM59.7706 35.7414C65.0678 35.7414 69.1971 32.6966 70.4484 28.4838H64.4838C63.8165 29.902 62.0647 30.7779 60.0626 30.7779C56.5172 30.7779 54.682 28.6507 54.4317 26.1898H70.6987C70.9906 18.3483 65.9437 13.9687 59.8123 13.9687C53.4724 13.9687 48.8426 18.5985 48.8426 24.8133C48.8426 31.1533 53.389 35.7414 59.7706 35.7414ZM64.4421 22.4359H54.6403C55.1825 20.1418 57.0177 18.5985 59.6455 18.5985C61.6058 18.5985 63.7331 19.6413 64.4421 22.4359ZM98.8113 35.7831C107.612 35.7831 114.745 29.7351 113.41 17.5558H98.1022V23.2284H107.153C106.486 27.316 103.608 29.9437 98.8113 29.9437C93.0553 29.9437 89.3014 25.7727 89.3014 20.4755C89.3014 15.1783 93.0553 11.0073 98.7279 11.0073C101.564 11.0073 104.317 12.2586 105.777 14.4275H112.701C110.699 8.83837 104.943 5.16788 98.7279 5.16788C89.7602 5.16788 83.2117 11.8832 83.2117 20.4755C83.2117 29.0678 89.7602 35.7831 98.8113 35.7831ZM123.379 35.2826V25.3139C123.379 21.8936 125.172 19.7664 127.883 19.7664C128.801 19.7664 129.593 19.9333 130.469 20.2252V14.4275C129.76 14.219 129.135 14.1773 128.551 14.1773C126.215 14.1773 124.088 15.7205 123.379 17.7643V14.4275H117.664V35.2826H123.379ZM141.856 35.7414C144.734 35.7414 146.945 34.2815 147.862 32.9468V35.2826H153.577V14.4275H147.862V16.7633C146.945 15.4286 144.734 13.9687 141.856 13.9687C136.309 13.9687 132.054 18.9322 132.054 24.8551C132.054 30.7779 136.309 35.7414 141.856 35.7414ZM143.066 30.5276C139.937 30.5276 137.81 28.1084 137.81 24.8551C137.81 21.6017 139.937 19.1825 143.066 19.1825C146.194 19.1825 148.321 21.6017 148.321 24.8551C148.321 28.1084 146.194 30.5276 143.066 30.5276ZM164.838 44V32.9468C165.798 34.2815 168.008 35.7414 170.886 35.7414C176.434 35.7414 180.688 30.7779 180.688 24.8551C180.688 18.9322 176.434 13.9687 170.886 13.9687C168.008 13.9687 165.798 15.4286 164.838 16.7633V14.4275H159.124V44H164.838ZM169.635 30.5276C166.507 30.5276 164.38 28.1084 164.38 24.8551C164.38 21.6017 166.507 19.1825 169.635 19.1825C172.763 19.1825 174.891 21.6017 174.891 24.8551C174.891 28.1084 172.763 30.5276 169.635 30.5276ZM190.574 35.2826V25.1053C190.574 21.1011 192.576 19.1825 195.203 19.1825C197.581 19.1825 198.874 21.0177 198.874 24.0209V35.2826H204.588V23.0615C204.588 17.6392 201.585 13.9687 196.538 13.9687C193.827 13.9687 191.658 15.1366 190.574 16.805V4H184.859V35.2826H190.574Z" fill="#F8F6FF"/>
                    </svg>
                </div>
                <h1>Delegator Dashboard</h1>
                <p>Analyze your delegations, track rewards, and monitor indexer performance on The Graph Network</p>
            </div>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    class="search-input" 
                    id="walletInput"
                    placeholder="Enter wallet address (0x...)"
                    value="0x1908a3232eed9186b4a5b666075711d2db0200e5"
                >
                <button class="search-btn" id="searchBtn" onclick="analyzeDelegations()">
                    Analyze Delegations
                </button>
            </div>
            
            <div class="demo-addresses">
                <div class="demo-title">üìã Try these demo addresses:</div>
                <div class="demo-address" onclick="setAddress('0x1908a3232eed9186b4a5b666075711d2db0200e5')">
                    0x1908a3232eed9186b4a5b666075711d2db0200e5
                </div>
                <div class="demo-address" onclick="setAddress('0x825b0a6393fc7c25f44f1985ad7857424bfb9ae6')">
                    0x825b0a6393fc7c25f44f1985ad7857424bfb9ae6
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="powered-by">
                <h3>üöÄ Ready to Use!</h3>
                <p>No API key required - just enter a wallet address above to analyze delegations with real-time data from The Graph Network.</p>
            </div>
        </div>
    </div>

    <script>
        // Suppress wallet extension errors that don't affect our functionality
        window.addEventListener('error', function(e) {
            if (e.filename && (e.filename.includes('evmAsk.js') || e.filename.includes('requestProvider.js'))) {
                e.preventDefault();
                return false;
            }
        });

        function setAddress(address) {
            document.getElementById('walletInput').value = address;
        }

        function formatGRT(wei) {
            if (!wei) return '0';
            const grt = parseFloat(wei) / 1e18;
            if (grt >= 1000000) {
                return (grt / 1000000).toFixed(2) + 'M';
            } else if (grt >= 1000) {
                return (grt / 1000).toFixed(2) + 'K';
            } else {
                return grt.toFixed(2);
            }
        }

        function formatPercentage(partsPerMillion) {
            const percentage = (partsPerMillion / 1000000) * 100;
            return percentage.toFixed(2) + '%';
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function calculateUnrealizedRewards(stakedTokens, personalExchangeRate, currentExchangeRate) {
            if (!personalExchangeRate || !currentExchangeRate || !stakedTokens) return 0;
            
            const currentValue = (parseFloat(stakedTokens) * parseFloat(currentExchangeRate)) / parseFloat(personalExchangeRate);
            const unrealizedRewards = currentValue - parseFloat(stakedTokens);
            return unrealizedRewards;
        }

        function getIndexerAvatar(indexer) {
            if (indexer.account && indexer.account.metadata && indexer.account.metadata.image) {
                return `<img src="${indexer.account.metadata.image}" alt="${indexer.defaultDisplayName}" onerror="this.style.display='none'; this.parentElement.innerHTML='${indexer.defaultDisplayName.charAt(0).toUpperCase()}';">`;
            }
            
            return indexer.defaultDisplayName ? indexer.defaultDisplayName.charAt(0).toUpperCase() : '?';
        }

        function getIndexerWebsite(indexer) {
            if (indexer.account && indexer.account.metadata && indexer.account.metadata.website) {
                return indexer.account.metadata.website;
            }
            return indexer.url || '#';
        }

        function getIndexerDescription(indexer) {
            if (indexer.account && indexer.account.metadata && indexer.account.metadata.description) {
                return indexer.account.metadata.description;
            }
            return null;
        }

        function showError(title, message, details = null, showRetry = false) {
            const retryButton = showRetry ? `<button class="retry-btn" onclick="analyzeDelegations()">Try Again</button>` : '';
            const errorDetails = details ? `<div class="error-details"><strong>Technical Details:</strong><br>${details}</div>` : '';
            
            return `
                <div class="error">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    ${errorDetails}
                    ${retryButton}
                </div>
            `;
        }

        async function analyzeDelegations() {
            const walletAddress = document.getElementById('walletInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('results');
            const searchBtn = document.getElementById('searchBtn');

            if (!walletAddress || !walletAddress.startsWith('0x')) {
                resultsDiv.innerHTML = showError(
                    'Invalid Address', 
                    'Please enter a valid wallet address starting with 0x'
                );
                return;
            }

            if (walletAddress.length !== 42) {
                resultsDiv.innerHTML = showError(
                    'Invalid Address Format', 
                    'Wallet address must be exactly 42 characters long (including 0x prefix)'
                );
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'Analyzing...';
            resultsDiv.innerHTML = '<div class="loading">üîç Fetching delegation data from The Graph Network...</div>';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch('/api/delegator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ walletAddress }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                let data;
                try {
                    const responseText = await response.text();
                    console.log('Raw response:', responseText.substring(0, 200));
                    
                    if (!responseText.trim()) {
                        throw new Error('Empty response from server');
                    }
                    
                    data = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('JSON parsing failed:', jsonError);
                    resultsDiv.innerHTML = showError(
                        'Server Response Error',
                        'The server returned an invalid response. This might be a temporary issue.',
                        `Response status: ${response.status}. JSON parsing failed: ${jsonError.message}`,
                        true
                    );
                    return;
                }

                if (!response.ok) {
                    console.error('API error:', response.status, data);
                    let errorMessage = 'An error occurred while fetching data.';
                    let errorDetails = `HTTP ${response.status}`;
                    
                    if (data.error) {
                        errorMessage = data.error;
                        if (data.details) {
                            errorDetails += `: ${data.details}`;
                        }
                    }
                    
                    resultsDiv.innerHTML = showError(
                        'API Error',
                        errorMessage,
                        errorDetails,
                        true
                    );
                    return;
                }

                if (data.data && data.data.delegator) {
                    displayDelegatorData(data.data.delegator);
                } else {
                    resultsDiv.innerHTML = showError(
                        'No Delegator Found',
                        'This wallet address has no delegation history on The Graph Network.',
                        'The wallet may not have any active or past delegations.'
                    );
                }

            } catch (error) {
                console.error('Request failed:', error);
                
                let errorMessage = 'Failed to connect to The Graph Network.';
                let errorDetails = error.message;
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out after 30 seconds.';
                    errorDetails = 'The Graph Network may be experiencing high load. Please try again.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Network connection failed.';
                    errorDetails = 'Please check your internet connection and try again.';
                }
                
                resultsDiv.innerHTML = showError(
                    'Connection Error',
                    errorMessage,
                    errorDetails,
                    true
                );
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Analyze Delegations';
            }
        }

        function displayDelegatorData(delegator) {
            const resultsDiv = document.getElementById('results');
            
            const totalStaked = formatGRT(delegator.totalStakedTokens);
            const totalRealized = formatGRT(delegator.totalRealizedRewards);
            const activeStakes = delegator.activeStakesCount;
            const totalStakes = delegator.stakesCount;

            let delegationsHTML = '';
            
            delegator.stakes.forEach(stake => {
                const indexer = stake.indexer;
                const isActive = !stake.lastUndelegatedAt;
                const stakedAmount = formatGRT(stake.stakedTokens);
                const realizedRewards = formatGRT(stake.realizedRewards);
                
                const unrealizedRewards = calculateUnrealizedRewards(
                    stake.stakedTokens,
                    stake.personalExchangeRate,
                    indexer.delegationExchangeRate
                );
                const unrealizedRewardsFormatted = formatGRT(unrealizedRewards.toString());
                
                const indexerName = indexer.defaultDisplayName || `Indexer ${indexer.id.substring(0, 8)}...`;
                const indexerWebsite = getIndexerWebsite(indexer);
                const indexerAvatar = getIndexerAvatar(indexer);
                const indexerDescription = getIndexerDescription(indexer);
                const createdDate = formatDate(indexer.createdAt);
                
                // Performance metrics - only show Total Rewards Earned and Query Fees Collected
                const totalRewardsEarned = formatGRT(indexer.rewardsEarned);
                const queryFeesCollected = formatGRT(indexer.queryFeesCollected);
                
                delegationsHTML += `
                    <div class="delegation-card">
                        <div class="indexer-header">
                            <div class="indexer-info">
                                <div class="indexer-avatar">${indexerAvatar}</div>
                                <div class="indexer-details-header">
                                    <div class="indexer-name">${indexerName}</div>
                                    ${indexerDescription ? `<div class="indexer-description">${indexerDescription}</div>` : ''}
                                    <div class="indexer-links">
                                        ${indexerWebsite !== '#' ? `<a href="${indexerWebsite}" target="_blank" class="indexer-url">üåê Website</a>` : ''}
                                    </div>
                                    <div class="created-date">Active since ${createdDate}</div>
                                </div>
                            </div>
                            <div class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                ${isActive ? '‚úÖ Active' : '‚ùå Inactive'}
                            </div>
                        </div>
                        
                        <div class="delegation-stats">
                            <div class="delegation-stat">
                                <div class="delegation-stat-value">${stakedAmount} GRT</div>
                                <div class="delegation-stat-label">Original Amount</div>
                            </div>
                            <div class="delegation-stat">
                                <div class="delegation-stat-value gain-positive">${unrealizedRewardsFormatted} GRT</div>
                                <div class="delegation-stat-label">Unrealized Rewards</div>
                            </div>
                            <div class="delegation-stat">
                                <div class="delegation-stat-value">${realizedRewards} GRT</div>
                                <div class="delegation-stat-label">Realized Rewards</div>
                            </div>
                        </div>
                        
                        <div class="indexer-details">
                            <div class="detail-item">
                                <span class="detail-label">Indexing Reward Cut:</span>
                                <span class="detail-value">${formatPercentage(indexer.indexingRewardCut)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Query Fee Cut:</span>
                                <span class="detail-value">${formatPercentage(indexer.queryFeeCut)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Total Pool Size:</span>
                                <span class="detail-value">${formatGRT(indexer.delegatedTokens)} GRT</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Indexer Self Stake:</span>
                                <span class="detail-value">${formatGRT(indexer.stakedTokens)} GRT</span>
                            </div>
                        </div>

                        <div class="performance-metrics">
                            <div class="metric-item">
                                <div class="metric-value">${totalRewardsEarned} GRT</div>
                                <div class="metric-label">Total Rewards Earned</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${queryFeesCollected} GRT</div>
                                <div class="metric-label">Query Fees Collected</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = `
                <div class="portfolio-summary">
                    <div class="portfolio-title">
                        üíº Portfolio Summary
                    </div>
                    <div class="portfolio-stats">
                        <div class="stat-item">
                            <div class="stat-value">${totalStaked} GRT</div>
                            <div class="stat-label">Total Staked</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalRealized} GRT</div>
                            <div class="stat-label">Realized Rewards</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${activeStakes}</div>
                            <div class="stat-label">Active Delegations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalStakes}</div>
                            <div class="stat-label">Total Delegations</div>
                        </div>
                    </div>
                </div>
                
                <h2 style="margin-bottom: 32px; color: #0C0A1D; font-size: 2rem; font-weight: 700;">üéØ Active Delegations</h2>
                ${delegationsHTML || '<p style="text-align: center; color: #494755; font-size: 1.2rem;">No active delegations found.</p>'}
            `;
        }

        window.addEventListener('load', () => {
            const defaultAddress = document.getElementById('walletInput').value;
            if (defaultAddress) {
                analyzeDelegations();
            }
        });
    </script>
</body>
</html>